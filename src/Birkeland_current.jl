# Birkeland Current Functions
# Used by T01 and T04 models

function birk_tot(ps, x, y, z, xkappa1, xkappa2)
    x_sc11 = xkappa1 - 1.1; x_sc21 = xkappa2 - 1.0  # region1: -1.1, region2: -1.0
    f11 = birk_1n2(1, 1, ps, x, y, z, xkappa1)
    h11 = birk_shl(SH11, ps, x_sc11, x, y, z)
    f12 = birk_1n2(1, 2, ps, x, y, z, xkappa1)
    h12 = birk_shl(SH12, ps, x_sc11, x, y, z)
    f21 = birk_1n2(2, 1, ps, x, y, z, xkappa2)
    h21 = birk_shl(SH21, ps, x_sc21, x, y, z)
    f22 = birk_1n2(2, 2, ps, x, y, z, xkappa2)
    h22 = birk_shl(SH22, ps, x_sc21, x, y, z)
    return (f11 .+ h11), (f12 .+ h12), (f21 .+ h21), (f22 .+ h22)
end

function birk_1n2(numb, mode, ps, x, y, z, xkappa)
    # Select coefficient array based on region and mode
    a = numb == 1 ? (mode == 1 ? A11 : A12) : (mode == 1 ? A21 : A22)

    beta, rh, eps, b_param, rho_0 = 0.9, 10.0, 3.0, 0.5, 7.0
    dphi = numb == 1 ? 0.055 : 0.03
    dtheta = numb == 1 ? 0.06 : 0.09

    # Scale coordinates
    xsc, ysc, zsc = x * xkappa, y * xkappa, z * xkappa
    rho = sqrt(xsc^2 + zsc^2)
    rsc = sqrt(xsc^2 + ysc^2 + zsc^2)
    rho2 = rho_0^2

    # Cylindrical phi
    phi = (xsc == 0.0 && zsc == 0.0) ? 0.0 : atan(-zsc, xsc)
    sphic, cphic = sincos(phi)

    # Deformation
    brack = dphi + b_param * rho2 / (rho2 + 1.0) * (rho^2 - 1.0) / (rho2 + rho^2)
    r1rh = (rsc - 1.0) / rh
    psias = beta * ps / (1.0 + r1rh^eps)^(1.0 / eps)

    phis = phi - brack * sin(phi) - psias
    dphisphi = 1.0 - brack * cos(phi)
    dphisrho = -2.0 * b_param * rho2 * rho / (rho2 + rho^2)^2 * sin(phi) + beta * ps * r1rh^(eps - 1) * rho / (rh * rsc * (1.0 + r1rh^eps)^(1.0 / eps + 1))
    dphisdy = beta * ps * r1rh^(eps - 1) * ysc / (rh * rsc * (1.0 + r1rh^eps)^(1.0 / eps + 1))

    sphics, cphics = sincos(phis)
    xs = rho * cphics
    zs = -rho * sphics

    # Call twocones with deformed coordinates
    bxs, byas, bzs = twocones(a, xs, ysc, zs, mode, dtheta)

    # Transform back
    brhoas = bxs * cphics - bzs * sphics
    bphias = -bxs * sphics - bzs * cphics

    brho_s = brhoas * dphisphi * xkappa
    bphi_s = (bphias - rho * (byas * dphisdy + brhoas * dphisrho)) * xkappa
    by_s = byas * dphisphi * xkappa

    bx = brho_s * cphic - bphi_s * sphic
    by = by_s
    bz = -brho_s * sphic - bphi_s * cphic

    return bx, by, bz
end

function twocones(a, x, y, z, mode, dtheta)
    bxn, byn, bzn = one_cone(a, x, y, z, mode, dtheta)
    bxs, bys, bzs = one_cone(a, x, -y, -z, mode, dtheta)
    return bxn - bxs, byn + bys, bzn + bzs
end

function one_cone(a, x, y, z, mode, dtheta)
    dr, dt = 1.0e-6, 1.0e-6
    theta0 = a[31]

    rho2 = x^2 + y^2; rho = sqrt(rho2)
    r = sqrt(rho2 + z^2)
    r < 1.0e-8 && return 0.0, 0.0, 0.0

    theta = atan(rho, z)
    phi = atan(y, x)

    # Deformation
    rs = r_s(a, r, theta)
    thetas = theta_s(a, r, theta)

    # Field at deformed position
    btast, bfast = fialcos(rs, thetas, phi, mode, theta0, dtheta)

    # Derivatives for transformation
    drsdr = (r_s(a, r + dr, theta) - r_s(a, r - dr, theta)) / (2.0 * dr)
    drsdt = (r_s(a, r, theta + dt) - r_s(a, r, theta - dt)) / (2.0 * dt)
    dtsdr = (theta_s(a, r + dr, theta) - theta_s(a, r - dr, theta)) / (2.0 * dr)
    dtsdt = (theta_s(a, r, theta + dt) - theta_s(a, r, theta - dt)) / (2.0 * dt)

    stsst = sin(thetas) / max(sin(theta), 1.0e-10)
    rsr = rs / r

    # Transform field
    br = -rsr / r * stsst * btast * drsdt
    btheta = rsr * stsst * btast * drsdr
    bphi = rsr * bfast * (drsdr * dtsdt - drsdt * dtsdr)

    s = rho / r
    c = z / r
    sf = rho > 1.0e-10 ? y / rho : 0.0
    cf = rho > 1.0e-10 ? x / rho : 1.0

    be = br * s + btheta * c
    return a[1] * (be * cf - bphi * sf), a[1] * (be * sf + bphi * cf), a[1] * (br * c - btheta * s)
end

function r_s(a, r, theta)
    cost, cos2t = cos(theta), cos(2.0 * theta)
    return r + a[2] / r + a[3] * r / sqrt(r^2 + a[11]^2) + a[4] * r / (r^2 + a[12]^2) +
        (a[5] + a[6] / r + a[7] * r / sqrt(r^2 + a[13]^2) + a[8] * r / (r^2 + a[14]^2)) * cost +
        (a[9] * r / sqrt(r^2 + a[15]^2) + a[10] * r / (r^2 + a[16]^2)^2) * cos2t
end

function theta_s(a, r, theta)
    sint, sin2t, sin3t = sin(theta), sin(2.0 * theta), sin(3.0 * theta)
    return theta + (a[17] + a[18] / r + a[19] / r^2 + a[20] * r / sqrt(r^2 + a[27]^2)) * sint +
        (a[21] + a[22] * r / sqrt(r^2 + a[28]^2) + a[23] * r / (r^2 + a[29]^2)) * sin2t +
        (a[24] + a[25] / r + a[26] * r / (r^2 + a[30]^2)) * sin3t
end

function fialcos(r, theta, phi, n, theta0, dt)
    sinte, coste = sincos(theta)
    ro = r * sinte
    sinfi, cosfi = sincos(phi)
    tg = sinte / (1.0 + coste)   # tan(theta/2)
    ctg = sinte / (1.0 - coste)  # cot(theta/2)

    tetanp = theta0 + dt
    tetanm = theta0 - dt

    tgp, tgm, tgm2, tgp2 = 0.0, 0.0, 0.0, 0.0
    if theta >= tetanm
        tgp = tan(tetanp * 0.5)
        tgm = tan(tetanm * 0.5)
        tgm2 = tgm * tgm
        tgp2 = tgp * tgp
    end

    cosm1, sinm1 = 1.0, 0.0
    tm = 1.0
    tgm2m, tgp2m = 1.0, 1.0

    btn, bpn = 0.0, 0.0
    ccos_m, ssin_m = 0.0, 0.0

    for m in 1:n
        tm = tm * tg
        ccos_m = cosm1 * cosfi - sinm1 * sinfi
        ssin_m = sinm1 * cosfi + cosm1 * sinfi
        cosm1, sinm1 = ccos_m, ssin_m

        if theta < tetanm
            t = tm
            dtt = 0.5 * m * tm * (tg + ctg)
        elseif theta < tetanp
            tgm2m = tgm2m * tgm2
            fc = 1.0 / (tgp - tgm)
            fc1 = 1.0 / (2.0 * m + 1.0)
            tgm2m1 = tgm2m * tgm
            tg21 = 1.0 + tg * tg
            t = fc * (tm * (tgp - tg) + fc1 * (tm * tg - tgm2m1 / tm))
            dtt = 0.5 * m * fc * tg21 * (tm / tg * (tgp - tg) - fc1 * (tm - tgm2m1 / (tm * tg)))
        else
            tgp2m = tgp2m * tgp2
            tgm2m = tgm2m * tgm2
            fc = 1.0 / (tgp - tgm)
            fc1 = 1.0 / (2.0 * m + 1.0)
            t = fc * fc1 * (tgp2m * tgp - tgm2m * tgm) / tm
            dtt = -t * m * 0.5 * (tg + ctg)
        end

        btn = m * t * ccos_m / ro
        bpn = -dtt * ssin_m / r
    end

    btheta = btn * 800.0
    bphi = bpn * 800.0

    return btheta, bphi
end

function birk_shl(a, ps, x_sc, x, y, z)
    sps, cps = sincos(ps)
    s3ps = 2.0 * cps
    pst1, pst2 = ps * a[85], ps * a[86]
    st1, ct1 = sincos(pst1)
    st2, ct2 = sincos(pst2)
    x1, z1 = x * ct1 - z * st1, x * st1 + z * ct1
    x2, z2 = x * ct2 - z * st2, x * st2 + z * ct2

    bx, by, bz = 0.0, 0.0, 0.0
    l = 0
    for m in 1:2
        for i in 1:3
            p, q = a[72 + i], a[78 + i]
            sypi, cypi = sincos(y / p)
            syqi, cyqi = sincos(y / q)
            for k in 1:3
                r, s = a[75 + k], a[81 + k]
                szrk, czrk = sincos(z1 / r)
                szsk, czsk = sincos(z2 / s)
                sqpr = sqrt(1.0 / p^2 + 1.0 / r^2)
                sqqs = sqrt(1.0 / q^2 + 1.0 / s^2)
                epr = exp(x1 * sqpr)
                eqs = exp(x2 * sqqs)
                for n in 1:2
                    for nn in 1:2
                        if m == 1
                            fx = -sqpr * epr * cypi * szrk
                            fy = epr * sypi * szrk / p
                            fz = -epr * cypi * czrk / r
                            if n == 1
                                hx, hy, hz = nn == 1 ? (fx, fy, fz) : (fx * x_sc, fy * x_sc, fz * x_sc)
                            else
                                hx, hy, hz = nn == 1 ? (fx * cps, fy * cps, fz * cps) : (fx * cps * x_sc, fy * cps * x_sc, fz * cps * x_sc)
                            end
                        else  # m == 2
                            fx = -sps * sqqs * eqs * cyqi * czsk
                            fy = sps / q * eqs * syqi * czsk
                            fz = sps / s * eqs * cyqi * szsk
                            if n == 1
                                hx, hy, hz = nn == 1 ? (fx, fy, fz) : (fx * x_sc, fy * x_sc, fz * x_sc)
                            else
                                hx, hy, hz = nn == 1 ? (fx * s3ps, fy * s3ps, fz * s3ps) : (fx * s3ps * x_sc, fy * s3ps * x_sc, fz * s3ps * x_sc)
                            end
                        end
                        l += 1
                        ct, st = m == 1 ? (ct1, st1) : (ct2, st2)
                        hxr = hx * ct + hz * st
                        hzr = -hx * st + hz * ct
                        bx += hxr * a[l]
                        by += hy * a[l]
                        bz += hzr * a[l]
                    end
                end
            end
        end
    end
    return bx, by, bz
end



# Birkeland current shield coefficients
const SH11 = [
    46488.84663, -15541.95244, -23210.09824, -32625.03856, -109894.4551,
    -71415.32808, 58168.94612, 55564.87578, -22890.60626, -6056.763968,
    5091.3681, 239.7001538, -13899.49253, 4648.016991, 6971.310672,
    9699.351891, 32633.34599, 21028.48811, -17395.9619, -16461.11037,
    7447.621471, 2528.844345, -1934.094784, -588.3108359, -32588.88216,
    10894.11453, 16238.25044, 22925.60557, 77251.11274, 50375.97787,
    -40763.78048, -39088.6066, 15546.53559, 3559.617561, -3187.730438,
    309.1487975, 88.22153914, -243.0721938, -63.63543051, 191.1109142,
    69.94451996, -187.9539415, -49.89923833, 104.0902848, -120.2459738,
    253.5572433, 89.25456949, -205.6516252, -44.93654156, 124.7026309,
    32.53005523, -98.85321751, -36.51904756, 98.8824169, 24.88493459,
    -55.04058524, 61.14493565, -128.4224895, -45.3502346, 105.0548704,
    -43.66748755, 119.3284161, 31.38442798, -92.87946767, -33.52716686,
    89.98992001, 25.87341323, -48.86305045, 59.69362881, -126.5353789,
    -44.39474251, 101.5196856, 59.41537992, 41.18892281, 80.861012,
    3.066809418, 7.893523804, 30.56212082, 10.36861082, 8.222335945,
    19.97575641, 2.050148531, 4.992657093, 2.300564232, 0.2256245602, -0.05841594319,
]

const SH12 = [
    210260.4816, -1443587.401, -1468919.281, 281939.2993, -1131124.839,
    729331.7943, 2573541.307, 304616.7457, 468887.5847, 181554.7517,
    -1300722.65, -257012.8601, 645888.8041, -2048126.412, -2529093.041,
    571093.7972, -2115508.353, 1122035.951, 4489168.802, 75234.22743,
    823905.6909, 147926.6121, -2276322.876, -155528.5992, -858076.2979,
    3474422.388, 3986279.931, -834613.9747, 3250625.781, -1818680.377,
    -7040468.986, -414359.6073, -1295117.666, -346320.6487, 3565527.409,
    430091.9496, -0.1565573462, 7.377619826, 0.4115646037, -6.14607888,
    3.808028815, -0.5232034932, 1.454841807, -12.32274869, -4.466974237,
    -2.941184626, -0.6172620658, 12.6461349, 1.494922012, -21.35489898,
    -1.65225696, 16.81799898, -1.404079922, -24.09369677, -10.99900839,
    45.9423782, 2.248579894, 31.91234041, 7.575026816, -45.80833339,
    -1.507664976, 14.60016998, 1.348516288, -11.05980247, -5.402866968,
    31.69094514, 12.28261196, -37.55354174, 4.155626879, -33.70159657,
    -8.437907434, 36.22672602, 145.0262164, 70.73187036, 85.51110098,
    21.47490989, 24.34554406, 31.34405345, 4.655207476, 5.747889264,
    7.802304187, 1.844169801, 4.86725455, 2.941393119, 0.1379899178, 0.06607020029,
]

const SH21 = [
    162294.6224, 503885.1125, -27057.67122, -531450.1339, 84747.05678,
    -237142.1712, 84133.6149, 259530.0402, 69196.0516, -189093.5264,
    -19278.55134, 195724.5034, -263082.6367, -818899.6923, 43061.10073,
    863506.6932, -139707.9428, 389984.885, -135167.5555, -426286.9206,
    -109504.0387, 295258.3531, 30415.07087, -305502.9405, 100785.34,
    315010.9567, -15999.50673, -332052.2548, 54964.34639, -152808.375,
    51024.67566, 166720.0603, 40389.67945, -106257.7272, -11126.14442,
    109876.2047, 2.978695024, 558.6019011, 2.685592939, -338.000473,
    -81.9972409, -444.1102659, 89.44617716, 212.0849592, -32.58562625,
    -982.7336105, -35.10860935, 567.8931751, -1.917212423, -260.2023543,
    -1.023821735, 157.5533477, 23.00200055, 232.0603673, -36.79100036,
    -111.9110936, 18.05429984, 447.0481, 15.10187415, -258.7297813,
    -1.032340149, -298.6402478, -1.676201415, 180.5856487, 64.52313024,
    209.0160857, -53.8557401, -98.5216429, 14.35891214, 536.7666279,
    20.09318806, -309.734953, 58.54144539, 67.4522685, 97.92374406,
    4.75244976, 10.46824379, 32.9185611, 12.05124381, 9.962933904,
    15.91258637, 1.804233877, 6.578149088, 2.515223491, 0.1930034238, -0.02261109942,
]

const SH22 = [
    -131287.8986, -631927.6885, -318797.4173, 616785.8782, -50027.36189,
    863099.9833, 47680.2024, -1053367.944, -501120.3811, -174400.9476,
    222328.6873, 333551.7374, -389338.7841, -1995527.467, -982971.3024,
    1960434.268, 297239.7137, 2676525.168, -147113.4775, -3358059.979,
    -2106979.191, -462827.1322, 1017607.96, 1039018.475, 520266.9296,
    2627427.473, 1301981.763, -2577171.706, -238071.9956, -3539781.111,
    94628.1642, 4411304.724, 2598205.733, 637504.9351, -1234794.298,
    -1372562.403, -2.646186796, -31.10055575, 2.295799273, 19.20203279,
    30.01931202, -302.102855, -14.78310655, 162.1561899, 0.4943938056,
    176.8089129, -0.244492168, -100.6148929, 9.172262228, 137.430344,
    -8.451613443, -84.20684224, -167.3354083, 1321.830393, 76.89928813,
    -705.7586223, 18.28186732, -770.1665162, -9.084224422, 436.3368157,
    -6.374255638, -107.2730177, 6.080451222, 65.53843753, 143.2872994,
    -1028.009017, -64.2273933, 547.8536586, -20.58928632, 597.3893669,
    10.17964133, -337.7800252, 159.3532209, 76.34445954, 84.74398828,
    12.76722651, 27.63870691, 32.69873634, 5.145153451, 6.310949163,
    6.996159733, 1.971629939, 4.436299219, 2.904964304, 0.1486276863, 0.06859991529,
]

const A11 = [0.161806835, -0.1797957553, 2.999642482, -0.9322708978, -0.681105976, 0.2099057262, -8.358815746, -14.8603355, 0.3838362986, -16.30945494, 4.537022847, 2.685836007, 27.97833029, 6.330871059, 1.876532361, 18.95619213, 0.96515281, 0.4217195118, -0.0895777002, -1.823555887, 0.7457045438, -0.5785916524, -1.010200918, 0.01112389357, 0.09572927448, -0.3599292276, 8.713700514, 0.9763932955, 3.834602998, 2.492118385, 0.7113544659]
const A12 = [0.705802694, -0.2845938535, 5.715471266, -2.47282088, -0.7738802408, 0.347829393, -11.37653694, -38.64768867, 0.6932927651, -212.4017288, 4.944204937, 3.071270411, 33.05882281, 7.387533799, 2.366769108, 79.22572682, 0.6154290178, 0.5592050551, -0.1796585105, -1.65493221, 0.7309108776, -0.4926292779, -1.130266095, -0.009613974555, 0.1484586169, -0.2215347198, 7.883592948, 0.02768251655, 2.950280953, 1.212634762, 0.5567714182]
const A21 = [0.1278764024, -0.2320034273, 1.805623266, -32.3724144, -0.9931490648, 0.317508563, -2.492465814, -16.21600096, 0.2695393416, -6.752691265, 3.971794901, 14.54477563, 41.10158386, 7.91288973, 1.258297372, 9.583547721, 1.014141963, 0.5104134759, -0.1790430468, -1.756358428, 0.7561986717, -0.6775248254, -0.0401401642, 0.01446794851, 0.1200521731, -0.2203584559, 4.50896385, 0.8221623576, 1.77993373, 1.102649543, 0.886788002]
const A22 = [0.4036015198, -0.3302974212, 2.82773093, -45.4440583, -1.611103927, 0.4927112073, -0.003258457559, -49.59014949, 0.3796217108, -233.7884098, 4.31266698, 18.05051709, 28.95320323, 11.09948019, 0.7471649558, 67.10246193, 0.5667096597, 0.6468519751, -0.1560665317, -1.460805289, 0.7719653528, -0.6658988668, 0.2515179349e-5, 0.02426021891, 0.1195003324, -0.2625739255, 4.377172556, 0.2421190547, 2.503482679, 1.071587299, 0.724799743]